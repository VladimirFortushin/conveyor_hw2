name: build -> test -> download -> self_ssh -> vm -> deploy

on:
  push:
    branches: [ master ]

env:
  VM_USER: vladimir
  VM_HOST: 192.168.196.131
  DEPLOYMENT_DIR: /home/vladimir/mephi/wildfly/standalone/deployments
  SOURCE_WAR_PATH: target/webapp.war
  WAR_NAME: webapp.war

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    
    steps:
    - name: checkout
      uses: actions/checkout@v4
    
    - name: jdk21 setup
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: build war
      run: mvn clean package -DskipTests

    - name: wildfly setup and deploy .war
      run: |
        wget -q https://github.com/wildfly/wildfly/releases/download/37.0.1.Final/wildfly-37.0.1.Final.tar.gz
        tar -xzf wildfly-37.0.1.Final.tar.gz
        mv wildfly-37.0.1.Final wildfly
        cp target/webapp.war wildfly/standalone/deployments/
        cd wildfly/bin
        ./standalone.sh &
        sleep 30
    
    - name: test
      run: mvn test
      
    - name: save .war
      uses: actions/upload-artifact@v4
      with:
        name: webapp-war
        path: target/webapp.war
        retention-days: 1

  deploy_on_vm:
    needs: build_and_test
    runs-on: self-hosted
    
    steps:
    - name: dwnld .war to local machine
      uses: actions/download-artifact@v4
      with:
        name: webapp-war
        path: /tmp
    
    - name: remove old .war
      run: |
        ssh ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          cd ${{ env.DEPLOYMENT_DIR }}
          rm -f ${{ env.WAR_NAME }} \
                 ${{ env.WAR_NAME }}.deployed \
                 ${{ env.WAR_NAME }}.failed \
                 ${{ env.WAR_NAME }}.isdeploying \
                 2>/dev/null || true
        "
    
    - name: cp new .war to VM
      run: |
        scp /tmp/webapp.war ${{ env.VM_USER }}@${{ env.VM_HOST }}:${{ env.DEPLOYMENT_DIR }}/
    
    - name: reboot wildfly
      run: |
        ssh ${{ env.VM_USER }}@${{ env.VM_HOST }} "sudo systemctl restart wildfly"
        sleep 30
    
    - name: verify deployment
      run: |
        ssh ${{ env.VM_USER }}@${{ env.VM_HOST }} "curl -f http://localhost:8080/webapp/do/test"
