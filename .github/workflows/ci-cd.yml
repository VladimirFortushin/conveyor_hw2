name: build -> test -> download -> local_deploy

on:
  push:
    branches: [ master ]

env:
  VM_USER: vladimir
  VM_HOST: 192.168.196.131
  DEPLOYMENT_DIR: /home/vladimir/mephi/wildfly/standalone/deployments
  SOURCE_WAR_PATH: target/webapp.war
  WAR_NAME: webapp.war

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    
    steps:
    - name: checkout
      uses: actions/checkout@v4
    
    - name: jdk21 setup
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: build war
      run: mvn clean package -DskipTests

    - name: wildfly setup and deploy .war
      run: |
        wget -q https://github.com/wildfly/wildfly/releases/download/37.0.1.Final/wildfly-37.0.1.Final.tar.gz
        tar -xzf wildfly-37.0.1.Final.tar.gz
        mv wildfly-37.0.1.Final wildfly
        cp target/webapp.war wildfly/standalone/deployments/
        cd wildfly/bin
        ./standalone.sh &
        sleep 30
    
    - name: test
      run: mvn test
      
    - name: save .war
      uses: actions/upload-artifact@v4
      with:
        name: webapp-war
        path: target/webapp.war
        retention-days: 1

  deploy_local_machine:
    needs: build_and_test
    runs-on: self-hosted
    
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: webapp-war
    
    - run: cp webapp.war "/c/Users/$(whoami)/Desktop/installations/wildfly-37.0.1.Final/standalone/deployments/"
    
    - run: echo "Файл скопирован. Перезапустите WildFly вручную если нужно."
